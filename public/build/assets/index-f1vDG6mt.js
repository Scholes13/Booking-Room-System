const g=()=>{const e=document.querySelectorAll(".booking-row"),t=new Date().toISOString().split("T")[0],n=S(e,t);I(n)},S=(e,t)=>{let n={todayCount:0,nextBooking:null,rooms:new Map,departments:new Map,weeklyCount:0};const o=new Date,a=new Date;return a.setDate(a.getDate()-a.getDay()),e.forEach(r=>{if(r.style.display!=="none"){const i=r.querySelector(".booking-date").innerText,m=r.querySelector(".booking-time").innerText,D=r.querySelector("td:nth-child(2)").innerText,k=r.querySelector("td:nth-child(6)").innerText;T(n,i,m,k,t,o),x(n,i,a),B(n,k),C(n,D)}}),n},T=(e,t,n,o,a,r)=>{if(t===a){e.todayCount++;const i=new Date(`${t} ${n}`);i>r&&(!e.nextBooking||i<e.nextBooking.time)&&(e.nextBooking={time:i,room:o})}},x=(e,t,n)=>{new Date(t)>=n&&e.weeklyCount++},B=(e,t)=>{e.rooms.set(t,(e.rooms.get(t)||0)+1)},C=(e,t)=>{e.departments.set(t,(e.departments.get(t)||0)+1)},I=e=>{q(e),A(e),E(e),L(e)},q=e=>{document.getElementById("todayBookings").textContent=e.todayCount,document.getElementById("nextBookingInfo").textContent=e.nextBooking?`Booking berikutnya: ${e.nextBooking.time.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})} di ${e.nextBooking.room}`:"Tidak ada booking berikutnya"},A=e=>{const[t,n]=[...e.rooms.entries()].reduce((a,[r,i])=>i>a[1]?[r,i]:a,["",0]),o=Math.round(n/10*100);document.getElementById("roomUsage").textContent=`${o}%`,document.getElementById("mostUsedRoom").textContent=`${t||"-"}`},E=e=>{document.getElementById("weeklyBookings").textContent=e.weeklyCount,document.getElementById("weeklyTrend").textContent="Total booking minggu ini"},L=e=>{const[t,n]=[...e.departments.entries()].reduce((o,[a,r])=>r>o[1]?[a,r]:o,["",0]);document.getElementById("activeDepts").textContent=e.departments.size,document.getElementById("topDepartment").textContent=t?`Departemen teraktif: ${t}`:"Belum ada departemen aktif"},y=()=>{const e=new Date().toISOString().split("T")[0]+" "+new Date().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit",second:"2-digit"});document.querySelectorAll(".booking-row").forEach(t=>{const n=t.getAttribute("data-endtime");n&&n<e?t.classList.add("expired-booking"):t.classList.remove("expired-booking")})};let s=!1;const c=()=>{document.getElementById("loadingOverlay").classList.remove("hidden"),s=!0},l=()=>{document.getElementById("loadingOverlay").classList.add("hidden"),s=!1},d=e=>{var t;document.querySelectorAll(".filter-btn").forEach(n=>{n.classList.remove("active")}),e&&((t=document.getElementById(e))==null||t.classList.add("active")),localStorage.setItem("activeFilter",e||"")},u=async(e,t)=>{const n=e.map(async o=>{t(o)?(o.style.display="",o.classList.remove("hidden")):(o.classList.add("hidden"),await new Promise(r=>setTimeout(r,50)),o.style.display="none")});await Promise.all(n),updateDashboardStats()},f=(e,t)=>{e.preventDefault(),Swal.fire({title:"Apakah Anda yakin?",text:"Data booking akan dihapus permanen!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#6b7280",confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal",background:"#1f2937",color:"#fff"}).then(n=>{n.isConfirmed&&t.submit()})},w=async()=>{if(!s){c();try{const e=new Date().toISOString().split("T")[0],t=Array.from(document.querySelectorAll(".booking-row"));await u(t,n=>n.querySelector(".booking-date").innerText===e),d("btnToday")}finally{l()}}},p=async()=>{if(!s){c();try{const e=new Date,t=new Date(e.setDate(e.getDate()-e.getDay())),n=new Date(e.setDate(t.getDate()+6)),o=Array.from(document.querySelectorAll(".booking-row"));await u(o,a=>{const r=new Date(a.querySelector(".booking-date").innerText);return r>=t&&r<=n}),d("btnWeek")}finally{l()}}},h=async()=>{if(!s){c();try{const e=new Date,t=e.getHours(),n=e.toISOString().split("T")[0],o=Array.from(document.querySelectorAll(".booking-row"));await u(o,a=>{const r=a.querySelector(".booking-date").innerText,i=a.querySelector(".booking-time").innerText.split(":"),m=parseInt(i[0]);return r===n&&m===t}),d("btnHour")}finally{l()}}},b=async()=>{if(!s){c();try{const e=new Date().getMonth(),t=new Date().getFullYear(),n=Array.from(document.querySelectorAll(".booking-row"));await u(n,o=>{const a=new Date(o.querySelector(".booking-date").innerText);return a.getMonth()===e&&a.getFullYear()===t}),d("btnMonth")}finally{l()}}},v=async()=>{if(!s){c();try{Array.from(document.querySelectorAll(".booking-row")).forEach(t=>{t.style.display="",t.classList.remove("hidden")}),d(null),y(),g()}finally{l()}}},M=()=>{y(),g(),setInterval(()=>{y(),g()},6e4),O(),F()},O=()=>{const e=localStorage.getItem("activeFilter");if(e)switch(e){case"btnToday":w();break;case"btnWeek":p();break;case"btnHour":h();break;case"btnMonth":b();break}},F=()=>{document.querySelectorAll('form[action*="delete"]').forEach(e=>{e.onsubmit=t=>f(t,e)})};document.addEventListener("DOMContentLoaded",M);window.filterToday=w;window.filterThisWeek=p;window.filterHour=h;window.filterThisMonth=b;window.resetFilter=v;window.confirmDelete=f;
